name: Test Home Manager Configurations

on:
  push:
    branches:
      - main
    paths:
      - 'home-manager/**'
      - 'nix-darwin/**'
      - 'flake.nix'
      - 'flake.lock'
  pull_request:
    branches:
      - main
    paths:
      - 'home-manager/**'
      - 'nix-darwin/**'
      - 'flake.nix'
      - 'flake.lock'
  workflow_dispatch:

jobs:
  test-configs:
    name: Test ${{ matrix.config }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Test Home Manager configurations
          - config: macbook-pro-m3
            os: macos-latest
            platform: darwin
            system: aarch64-darwin
            type: home-manager
          - config: nixos-orbstack
            os: ubuntu-latest
            platform: linux
            system: aarch64-linux
            type: home-manager
          # Test nix-darwin configurations
          - config: macbook-pro-m3
            os: macos-latest
            platform: darwin
            system: aarch64-darwin
            type: nix-darwin
          - config: macbook-air-m4
            os: macos-latest
            platform: darwin
            system: aarch64-darwin
            type: nix-darwin

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Set test environment variables
        run: |
          # Set test username for configurations that need it
          echo "USER=testuser" >> $GITHUB_ENV
          # Keep the existing HOME directory (GitHub runner's home)
          echo "REAL_HOME=$HOME" >> $GITHUB_ENV
          # Set hostname for testing
          echo "HOSTNAME=github-runner" >> $GITHUB_ENV

      - name: Test flake evaluation
        run: |
          cd ${{ github.workspace }}
          echo "Testing flake configuration: ${{ matrix.config }}"

          # Check that the flake is valid
          nix flake check --show-trace

          # Show available configurations
          echo "Available configurations:"
          nix flake show

      - name: Test configuration build
        run: |
          cd ${{ github.workspace }}
          echo "Building ${{ matrix.type }} configuration: ${{ matrix.config }}"

          if [[ "${{ matrix.type }}" == "home-manager" ]]; then
            # Build Home Manager configuration
            nix build .#homeConfigurations.${{ matrix.config }}.activationPackage \
              --no-link \
              --show-trace \
              --print-build-logs
          elif [[ "${{ matrix.type }}" == "nix-darwin" ]]; then
            # Build nix-darwin configuration
            nix build .#darwinConfigurations.${{ matrix.config }}.system \
              --no-link \
              --show-trace \
              --print-build-logs
          fi

      - name: Test configuration evaluation
        run: |
          cd ${{ github.workspace }}
          echo "Evaluating ${{ matrix.type }} configuration for detailed analysis..."

          if [[ "${{ matrix.type }}" == "home-manager" ]]; then
            # Test Home Manager configuration evaluation
            nix eval .#homeConfigurations.${{ matrix.config }}.config.home.stateVersion \
              --show-trace

            # Test that packages are available
            echo "Testing package availability..."
            nix eval .#homeConfigurations.${{ matrix.config }}.config.home.packages \
              --apply "builtins.length" \
              --show-trace
          elif [[ "${{ matrix.type }}" == "nix-darwin" ]]; then
            # Test nix-darwin configuration evaluation
            nix eval .#darwinConfigurations.${{ matrix.config }}.config.system.stateVersion \
              --show-trace

            # Test that system packages are available
            echo "Testing system package availability..."
            nix eval .#darwinConfigurations.${{ matrix.config }}.config.environment.systemPackages \
              --apply "builtins.length" \
              --show-trace
          fi

      - name: Check for common issues
        run: |
          cd ${{ github.workspace }}
          echo "Checking for common configuration issues..."

          # Check if all imported files exist
          echo "Checking Nix syntax..."
          if ! find home-manager -name "*.nix" -exec nix-instantiate --parse {} \; > /dev/null; then
            echo "âŒ Syntax errors found in home-manager nix files"
            exit 1
          fi

          if ! find nix-darwin -name "*.nix" -exec nix-instantiate --parse {} \; > /dev/null; then
            echo "âŒ Syntax errors found in nix-darwin nix files"
            exit 1
          fi

          # Check flake syntax
          echo "Checking flake syntax..."
          nix flake check

          echo "âœ… Basic checks passed"

      - name: Generate build artifacts info
        if: always()
        run: |
          cd ${{ github.workspace }}
          echo "## Configuration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration**: ${{ matrix.config }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ matrix.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **System**: ${{ matrix.system }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… Configuration builds successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Configuration failed to build" >> $GITHUB_STEP_SUMMARY
          fi

  test-matrix-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: test-configs
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Home Manager Configuration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.test-configs.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **All configurations passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All host configurations build successfully and are ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some configurations failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the individual job results above for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tested Configurations:" >> $GITHUB_STEP_SUMMARY
          echo "- **Home Manager**: macbook-pro-m3 (macOS), nixos-orbstack (Linux)" >> $GITHUB_STEP_SUMMARY
          echo "- **nix-darwin**: macbook-pro-m3 (macOS), macbook-air-m4 (macOS)" >> $GITHUB_STEP_SUMMARY
